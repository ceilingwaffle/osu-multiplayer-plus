// using TODO+ extension for vscode
TODO: 
    âœ” Fix `Error: Multiplayer 54078930 is not currently being watched` when using `!endgame` command @created(19-08-30 07:43) @done(19-08-30 23:29)
    âœ” Fix `!obr removelobby` command not unwatching the lobby in the osu lobby scanner @created(19-08-30 23:29) @done(19-08-30 23:52)
    â˜ Remove all the comments starting with "GL:" from when we implemented the GameLobby entity @created(19-08-30 07:48)
    âœ” Completely rework adding/removing lobbies from games @created(19-08-28 20:27) @started(19-08-28 20:20) @done(19-08-30 07:41) @lasted(1d11h21m46s)
    Storing add/remove values on a many-to-many GamesLobby table: https://github.com/typeorm/typeorm/issues/1224
    â˜ Remove GameStatus.UNKNOWN
    Using "UNKNOWN" feels lazy. If there's an error preventing a known-status being applied, we should just throw an error instead of resorting to an "UNKNOWN" status. Also having a game status as "UNKNOWN" means that status has to be handled in some way eventually, so why not just handle it that way to start with?
    â˜ Explore the osu! API - we need to know if submitting a map when you're in a multi will display the map in your "recent" played maps. This is mainly for MING MODE where we need to know - if it's displayed in your recent plays with an F (if failed in a multi). Does it only show F if you didn't recover in the multi, or will it show some letter (S,A,B,C,D) when you recover before the end of the map.
    â˜ Take a look at the new osu! API
    âœ” Use test Discord Commando database depending on env context @started(19-08-26 21:40) @done(19-08-27 08:11) @lasted(10h31m25s)
    Bugs:
        Critical:
        Important:
            â˜ !creategame should change the target game of the requesting user to that game. @created(19-09-19 13:00)
        Optimize:
            â˜ Lobby scanner should start scanning immediately when a lobby is added. Right now, it waits the interval time before doing the first scan. @created(19-09-19 13:13)
    Security:
        â˜ The !addteam command could be abused if a user spams the command with a bunch of osu usernames over and over again, because the addteam process involves validating the osu usernames with the osu API, meaning this is an effective DoS attack. @created(19-09-07 17:42)
            â˜ We need some kind of rate limiter for the actions the users can do @created(19-09-07 17:43)
                â˜ To add a rate limiter, we need to record where in the code API requests are originating from, and if the user triggers some process which involves one of these API requests, we add that to the rate limiter.  @created(19-09-07 17:43)
                â˜ The goal should be to share the API load between users, maybe using some kind of back-off approach, where actions triggered by the spamming user get slower and slower for each additional spam command sent. @created(19-09-07 17:48)
    Functionality:
        Game in Progress:
            Things to Handle:
                â˜ All players of a team do not submit a score @created(19-09-02 13:36)
                    â˜ Option 1: Team loses a life @created(19-09-02 13:37)
                    âœ˜ Option 2: Team does not lose a life and we treat it as if they "skipped" this map @created(19-09-02 13:37) @cancelled(19-09-02 13:37)
                        Bad because it could be abused as a way to not lose lives.
                    â˜ Option 3: Team loses a life and receives warning that if they fail to submit a score on the next map, they will be immediately eliminated. @created(19-09-02 13:38)
                    â˜ Option 4: @created(19-09-02 13:39)
    Osu Lobby Watcher / Osu API:
        â˜ Persist osu watcher lobbies being watched after app exits @created(19-08-30 22:45)
        â˜ Rebuild osu-lobby-watcher.ts using listener and EventEmitter @created(19-08-27 12:09)
            https://github.com/onury/tasktimer
            https://blog.x5ff.xyz/blog/typescript-interval-iot/ 
            https://github.com/sindresorhus/emittery
            https://www.npmjs.com/package/async-eventemitter
        â˜ Load mpids from database lobbies for all active games when the app starts @created(19-09-03 11:15)
        â˜ Deny adding a lobby and send a warning to the user if the maximum allowed number of lobbies being scanned is reached @created(19-09-04 06:54)
            â˜ We can accomplish this by adding a method to IOsuApiFetcher like isMaxJobsReached() - which would compare the current number of lobbies being scanned with Bottleneck.limiter.maxConcurrent @created(19-09-04 06:58)
            â˜ If a user adds the bot from source code, using their own osu API key, the limit should be kept at 60 max requests per 60 seconds. The Bottleneck limiter should be able to dynamically set this depending on the user's own account API limit. @created(19-09-04 06:58)
    Error Messages:
        â˜ When adding a lobby before creating a game, the error message returned should replace "user ID X" with [at]DiscordUsername" instead (e.g. No games have been created by user ID 2. -> No games have been created by [at]CeilingWaffle
        â˜ Response<T> should be of type AddLobbyFailureReport and contain a discordUserId property
            â˜ When adding an invalid bancho mp id (e.g. 1234) the error message should be better. Right now it's: banchoMultiplayerId: "1234" is bad because: [object Object]
    Server:
        â˜ Ensure app does not crash, or if it does, restart it in a reliable way
            Don't worry about uncaught exceptions like "connection closed" errors - just use foreverjs to restart the app in the event of failure.
        â˜ Handle internet disconnections by auto-reconnecting  @created(19-09-02 10:01)
            eg1: https://i.imgur.com/v4GDoRf.png
            eg2: https://i.imgur.com/9A5uA5A.png
    Social:
        Notable osu people showing interest:
            ThePooN, RyuK, Musty98
    Testing:
        â˜ Improve the Osu API Fetcher test (mock) class @created(19-09-14 23:27)
            â˜ Potential issue with the validation methods where they may incorrectly fail or succeed with the validation but the mocked class is just assuming they always succeed @created(19-09-14 23:27)
                â˜ One solution is just to unit test every line within the validation method, but if we add more lines in future we need to remember the unit test those aswell @created(19-09-14 23:28)
                â˜ Another solution is to mock the Nodesu API itself, instead of mocking the OsuAPIFetcher class @created(19-09-14 23:29)
        â˜ Write unit tests for ColorPicker class @created(19-09-11 13:45)
        â˜ Write tests for validating osu users (mock osu API?) @created(19-09-14 02:30)
            â˜ Assert that an invalid user generates a banchoOsuUserIdIsInvalidFailure from the TeamController (controller calling TeamService) @created(19-09-14 02:30)
        â˜ Write tests for adding users to teams @created(19-09-13 20:14)
            â˜ Assert that a TeamUser cannot exist consisting of the same Team and OsuUser (i.e. TeamUser should be unique) @created(19-09-13 20:14)
            â˜ Assert that multiple teams containing the same OsuUsers cannot exist @created(19-09-13 20:14)
            â˜ Assert that teams added with a group containing osu user ids listed in descending order are still added correctly (tests the alphaSort function) @created(19-09-13 20:16)
            â˜ Assert that a command containing duplicate username/user-id groups does not create multiple teams of the duplicate, but should still silently succeed, ignoring any duplicates @created(19-09-13 22:38)
            â˜ Assert that the color is unique for each GameTeam in a specific game @created(19-09-14 02:35)
        â˜ log4js - Write log to a separate file when running tests @created(19-09-08 09:52)
        â˜ log4js - Disable logging when running mocha tests in parallel, or log to a separate file for each test @created(19-09-08 09:52)
        â˜ Create test for testing the osu lobby scanner timer @created(19-09-06 10:07)
            âœ˜ Test that a watcher was disposed correctly while the timer is currently running @created(19-09-06 10:07) @cancelled(19-09-06 10:15)
                Solved this by just checking if watcher is defined as the first action in the scan() method, and don't continue with the scan if it's undefined.
        âœ” Speed up test execution times @created(19-08-30 23:52) @done(19-09-08 09:53)
            âœ” Can we run each group of tests in parallel by using a separate sqlite database for each group? @created(19-08-30 23:52) @done(19-09-08 09:53)
                âœ” Using an in-memory sqlite database solved this. Tests went from 2 minute exeuction times down to 15 seconds @created(19-09-08 09:53) @done(19-09-08 09:54)
        âœ” Finish writing commented-out tests in lobby-create.test.ts @started(19-08-18 20:12) @done(19-08-18 21:25) @lasted(1h13m39s)
        âœ” Run tests individually @done(19-08-18 22:41)
        âœ” Write tests for asserting lobby status after lobby-removal @started(19-08-20 05:22) @done(19-08-20 05:44) @lasted(22m21s)
        â˜ Finish writing tests for asserting error messages received when sending remove-lobby requests
        â˜ Write test for: Create a new user and add that user to a ref of a game, then assert that the user is a ref of that game
        â˜ Write test for LobbyService: Add 2 lobbies to a game, then remove 2 lobbies, then assert that game.lobbies.length = 0 @created(19-08-28 13:51)
        â˜ Create test suite for updating a game @created(19-08-31 13:58)
            â˜ Test user permission allowed/denied update @created(19-08-31 13:58)
        âœ” Write more tests for testing ending games @done(19-08-27 02:54)
        â˜ We have an issue where some tests are responsible for too much
            e.g. The end-game test is creating a game, changing the status, and ending the game. So now the test for "end game" will fail if the code fails in the GameControler under "create game".
            Solution 1 - Instead of calling controller methods, just directly modify the state of the database. The only disadvantage I can see to this is that there will be less test-coverage-redundancy, but this should be fine if we've tested every possible scenario in its own test. This way when a specific function fails, it will only fail the corresponding test.
        â˜ Replace assert.equal with assert.strictEqual
            I feel like using strictEqual would be less susceptible to some rare instances of tests passing when they shouldn't. I have no idea if this is actually true though. Needs research. 
    Database:
        â˜ Write typeorm migrations - but only once we go to production @created(19-08-27 08:08)
    Optimize: 
        â˜ Consider adding "use strict" to the top of all source files @created(19-08-30 23:18)
        â˜ Improve startup time for `npm run test`
        â˜ Fix having to restart the app multiple times waiting for database connection
            â˜ Handle soft/hard lobby deletes depending on whether or not matches exist for the given lobby.
            e.g. if the user adds the lobby, then immediately removes it, this is okay to hard delete.
        â˜ Too many match results being downloaded from the osu API.
            Need some way of limiting the maximum number of matches downloaded per multiplayer (right now we're using 500kb/s for 150+ matches in a single multi when polling every 1s)
    Refactor:
        âœ” Replace all uses of "NodesuApiFetcher.getInstance()" with a singleton instance of IOsuApiFetcher resolved from the inversify DIC @created(19-09-11 15:13) @done(19-09-14 22:41)
        â˜ Look into using LazyServiceIdentifier instead of lazyInject @created(19-09-09 23:15)
            â˜ The reason for this is so we can move the injections into constructor arguments. Then we'd have the option to overide these upon class initialization. @created(19-09-09 23:15)
        â˜ Move out files from src/discord/.. into their respective domain folders @created(19-09-07 18:26)
        â˜ Swap inversify back to typical @injectable() decorators on classes instead of using autoProvide with inversify.entities.ts file @created(19-09-02 09:58)
            This is just so we have one less dependency, and we can do things like mapping interfaces to class implementations. And create singleton instances of classes.
        â˜ Replace strings with Symbols in locale files e.g. en.json @created(19-08-28 19:41)
        â˜ Replace the default commando "catch-all" error-handler.
            Replace it with our own specific one with messages formatted the same as the ErrorDiscordMessageBuilder. Consider making ErrorDiscordMessageBuilder handle something less specific than just Response objects, or create another ErrorBuilder abstraction layer.
        â˜ Cleanup the failure methods. 
            Can we abstract and extend these? Keep them more consistent; less method signature copy pasting.
        â˜ Replace lolex with a spy in lobby-create.test.
            Using lolex is just a temp solution for now. The problem is if we use another timer anywhere else within the LobbyController.create method chain, it will replace all those timers with the lolex mock.
        â˜ Inject IOsuApiFetcher instead of getting directly from the DIC
            [12:00] bossqone: then you're hiding dependencies of your class, because you're passing whole container, not individual dependencies
            [12:07] bossqone: no problem at all, it will work anyway :) It's just tip to make your code more testable (e.g. you want to test that class. Now you need to construct whole DI container, bind correct instances, etc.., instead of passing mocked/correct instance directly to your class via constructor)
            
        @created(19-09-15 00:17)
    Inversify/ioc/dic/injectables dump:
        // @lazyInject(TYPES.GameService) private gameService: GameService;
        // @lazyInject(TYPES.Permissions) private permissions: Permissions;
        // @lazyInject(TYPES.RequesterFactory) private requesterFactory: RequesterFactory;
    
        // private gameService: GameService = iocContainer.get<GameService>(TYPES.GameService);
        // private permissions: Permissions = iocContainer.get<Permissions>(TYPES.Permissions);
        // private requesterFactory: RequesterFactory = iocContainer.get<RequesterFactory>(TYPES.RequesterFactory);
    
        // @inject(new LazyServiceIdentifer(() => TYPES.GameService)) protected gameService: GameService,
        // @inject(new LazyServiceIdentifer(() => TYPES.Permissions)) protected permissions: Permissions,
        // @inject(new LazyServiceIdentifer(() => TYPES.RequesterFactory)) protected requesterFactory: RequesterFactory
    
        // @inject(TYPES.GameService) protected gameService: GameService,
        // @inject(TYPES.Permissions) protected permissions: Permissions,
        // @inject(TYPES.RequesterFactory) protected requesterFactory: RequesterFactory
    Logging:
        â˜ Create more logger levels to make it easier to filter certain events @created(19-09-05 08:17)
            Like if we didn't care about classes being instantiated, all the instantiation Logger events could be turned off. 
            Or if we just wanted to see osu API events, we could just enable those.
        â˜ Can we create a separate log file for each game? @created(19-09-12 13:54)
            To make it easier to find and analyze the events of indivudual games.
    Pre-launch checklist:
        â˜ Some way of keeping dependencies secure and up-to-date
            Something like: https://dependabot.com/javascript/
        â˜ Contact peppy and see if we can get the API ratelimit increased from 60 max within 60 seconds to 1200 within 60 seconds. @created(19-09-04 06:57)
        â˜ Set typeorm logging settings to log to file only: @created(19-09-08 11:15)
            â˜ Queries with a long execution time @created(19-09-08 11:15)
            â˜ Query errors @created(19-09-08 11:15)
            https://github.com/typeorm/typeorm/blob/master/docs/logging.md
        â˜ Set log4js to log only warnings and errors to file @created(19-09-08 11:16)
        â˜ Move sqlite to postgres? Performance may be better (e.g. concurrency) @created(19-09-08 11:22)
        â˜ Prevent the app from launching multiple instances @created(19-09-10 13:05)
    Domain:
        âœ” Domain registered with Porkbun @created(19-09-20 01:06) @done(19-09-20 01:06)
    Design:
        What we have access to - maps, mods(SD), modes - team vs, ffa, TAG4, osu API
        â˜ We need a name for this thing
            â˜ Last Man Standing = LMS, so maybe lmsu -> lemonsu (good lord this is terrible; need more coffee)
            â˜ Multiplayer Plus / osu!MP+ / osu!MPP Bot
        â˜ Would be cool to run a single Discord server where everyone goes to create matches @created(19-09-10 13:45)
            â˜ And the server runs some official matches where users can sign up and earn prestige 
                â˜ With higher prestige getting higher roles, shown higher in the server list
            â˜ The bot should auto-create/schedule games and auto-select a random map pool
                e.g. DigitalHypno's tournament pool spreadsheet - https://docs.google.com/spreadsheets/d/1Pm1ihvelNLk5hyAxDir5o8UgPuqE9CEsJ00jBv3OLs4/edit#gid=1437326481
                    -- Average player rank should determine pool difficulty
            â˜ Users can create their own games, but no rewards will be granted (since this could be abused for farming prestige)
        Progression/Level-up Server System:
            Encourage people to use the bot more.
            â˜ Prestige Badges
            â˜ The more games you start, the more you level up.
            â˜ As you level up, you unlock more modes, e.g. like winner deciding who gets host.
            â˜ [1:18] Dionysaw: You unlock maps that you can play in lobbies
        Mini-Games:
            â˜ Voting for the winner
            â˜ Guess the roll
            â˜ osu! trivia quiz
        Game Modes:
            â˜ Team handicaps 
            â˜ Option to ignore score bonuses/reductions in score calculations (e.g. EZ 50% -> 100%, HD 106% -> 100%)
            â˜ Team Vs / Sudden Death idea
            Multiple lobby support for 16x16 teams. Could in theory have any nxn sizes, but maybe we want to limit it to 16x16 to make the chat experience better.
            â˜ Battle Royale / Last-Man-Standing, either solo or teams
                â˜ MING MODE - Whoever can pass with the lowest acc wins. Can't fail at any point.
                â˜ "True Elimination" Mode - Add option for kicking the losing team/player from the lobby within some short time after losing all their lives.
                    e.g. "CeilingWaffle doesn't feel so good..." *kicked*
                    â˜ Randomly request a roll of 50 or above to save themselves (to gain a life)
                â˜ The winner gets host
                â˜ The winner gets to the decide who gets kicked,
                    â˜ or maybe gets to choose one of the bottom 2 players to be kicked
                    â˜ or make it - everyone votes to decide who gets kicked
                    â˜ or the winner decides the target player, and the lobby votes yay or nay on whether or not they actually get kicked.
                â˜ If you SS, you gain a life, or temporarily gain some kind of forbidden power. Like you choose the next map. 
                â˜ If you're on 0 lives, you need to win the next map, otherwise you're eliminated. "One final chance" mode.
                â˜ Riwaka: One player can force a mod on the entire lobby
                    Would also be cool if one player could force a mod on a specific player
        Emoji Icons:
            ğŸ•¹ Game
            ğŸ  Lobby
            ğŸ‘ª Team
            ğŸ™‹ User/Ref
    Adding Lobbies:
        âœ” Currently, the lobby service is trying to add a new Lobby with the same banchoMultiplayerId rather than create a new Lobby-Game relationship. To fix this, add some code in the lobby service to check for the existing banchoMultiplayerId Lobby, and push the target-Game onto the lobby.games array. @started(19-08-18 17:00) @done(19-08-18 17:31) @lasted(31m15s)
        âœ” Make bancho multiplayer ID unique to lobby. No two lobbies should exist with the same mp ID. @done(19-08-18 19:49)
        â˜ We need some way to support adding a lobby after a game has already started. @created(19-09-07 18:57)
            e.g. if it's a game involving hundreds of players, and we want to pause and continue the next day/next week, the original lobby would be closed and re-created later - need to support that lobby re-creation step.
    User Permissions:
        https://github.com/tensult/role-acl
        âœ” Ensure that the user *removing a lobby* is a game ref or game creator @done(19-08-27 00:46)
        âœ” Ensure that the user *adding a lobby* is a game ref or game creator @done(19-08-27 00:46)
        âœ” Need some kind of game-permissions abstraction. e.g. user1.for(lobby).isPermittedTo(LobbyUpdateAction) - does a library already exist for this sort of thing? @done(19-08-27 00:46)
        â˜ Allow Discord roles to be used for app-roles. Use both Discord-roles and DB-user-roles.
        â˜ Create a more friendly action-specific "permission denied for action/resource" message @created(19-09-17 22:27)
            See permissions.ts - buildPermittedResult() method
    User-Game-Roles:
        âœ˜ After the game is created, add an entry in UserGameRoles using game id and requester-user id @cancelled(19-08-23 19:32)
        âœ˜ OLD IDEA -------- add the game without a relation to the UserGameRole, then create a new UserGameRole using gameCreator.userId + newGame.gameId + role === "game-creator" (this should update the game afterwards with a reference to the UserGameRole) @cancelled(19-08-23 19:32)
        âœ˜ Should we store a redundant reference to the game creator on the game entity? Possibly bad because now we have multiple references to the creator - what if we access it from the wrong entity while working on this in a few months time? @cancelled(19-08-23 19:32)
    Discord:
        Bot Permissions Required:
            â˜ Delete messages (e.g. user types yes to confirm destructive command - we need to delete that message) @created(19-08-30 23:06)
            â˜ Create text channels (to create game-specific channels) @created(19-08-30 23:07)
        Misc:
            â˜ Figure out how to handle the situation where the target-channel of the GameMessageTarget has been deleted. Where do messages get sent to? Maybe DM the original author?
            Use authorId as the message-target to do this.
            â˜ End game and shut-down watchers if the game target-channel is deleted. Listen for the "Channel Delete" event on the Discord.js Client: 
                Channel Delete event: https://discord.js.org/#/docs/main/stable/class/Client?scrollTo=e-channelDelete
                All Discord events: https://discord.js.org/#/docs/main/stable/typedef/WSEventType
                â˜ Also if the server is deleted. Is there an event for that? Send some kind of "server deleted, so we're shutting down the game" message to the original game author.
            âœ” Get user confirmation before performing destructive commands @created(19-08-26 21:53) @done(19-08-26 23:17)
                e.g. !obr endgame -> "Are you sure you want to end game 5? Enter yes to confirm."
            â˜ Delete the user's `yes` confirmation message @created(19-08-30 23:05)
            â˜ Send game-event messages to a specific game channel, and send @ replies to the user in the channel where they wrote the command. @created(19-08-28 08:22)
                e.g. User types !obr creategame.
                    Bot creates channel #obr-game-5
                    Bot replies in same channel "@user, The game has been created and channel #obr-game-5 was opened".
                    Bot emits message in #obr-game-5 with a game-created card containing the game properties.
                    Bot emits message with match results in #obr-game-5 when a lobby-match finishes.
                    Only admin, game-creator, and game ref are allowed to write messages in channel #obr-game-5.
        Commands:
            Discord:
                âœ˜ `!obr setchannel #<discordTextChannelName>` @created(19-09-01 23:50) @cancelled(19-09-10 19:27)
                    Sets the channel where match results and game-related messages will be delivered to.
            General:
                âœ˜ `!obr undo` @created(19-09-01 22:36) @cancelled(19-09-10 19:27)
                    Undoes the last command of the user. We won't need to confirm command actions with "yes" after this is implemented.
                    If this command is fired multiple times, it keeps undoing the command preceeding the previous undone one.
                âœ˜ `!obr redo` @created(19-09-01 22:36) @cancelled(19-09-10 19:27)
                    Redoes the last command of the user.
                âœ” `!obr targetgame <gameId>` @created(19-09-01 22:37) @done(19-09-10 19:27)
                    Sets the gameId as the target of the user's commands. If not used, the user's most recent game is the target.
            Game:
                âœ” `!obr creategame` @done(19-09-01 22:56)
                    âœ˜ Refuse `!obr creategame` command from a game-channel. @cancelled(19-08-22 20:14)
                        This *should* be OK to allow, but could be weird in situations where one game has an initial-channel as the game-channel of another game. Could be problematic with channel deletions. So just disallow this for now to be safe.
                    â˜ Warn the user if they use `!obr creategame` if the last game they created is still active @created(19-08-31 08:05)
                        "Looks like the last game you created is still active (game id x). Are you sure you want to start a new game? Reply with "yes" if so. Otherwise do nothing and this message will expire in t seconds." 
                    â˜ Alias `!obr creategame` -> `!obr newgame` @created(19-08-31 08:05)
                âœ” `!obr endgame <gameId?>` DESTRUCTIVE @created(19-09-01 22:48) @done(19-09-01 22:56)
                    â˜ Post final game results (if any) @created(19-09-10 13:37)
                âœ” `!obr editgame <prop> <propValue>` @created(19-08-31 23:41) @started(19-09-01 23:11) @done(19-09-02 12:36) @lasted(13h25m58s)
                â˜ `!obr startgame <gameId?>` @created(19-09-01 22:57)
                â˜ `!obr gameinfo <gameId?>` @created(19-08-31 23:41)
                    See types - https://discord.js.org/#/docs/commando/master/typedef/ArgumentInfo
                    Use a union type to check: If integer, assume gameId. If string, assume propKey.
                    Include description "use !obr targetgame to specify another game".
                â˜ `!obr listgames <active/closed/(default:all)?>` @created(19-09-01 22:38)
                    List the games created within this Discord server.
            Lobby:
                âœ” `!obr addlobby <banchoMpId>` @created(19-09-01 22:58) @done(19-09-01 23:05)
                    âœ” When using command !obr addlobby 54078930 6, on a game which already has that lobby added, return some error message. @started(19-08-19 00:30) @done(19-08-19 05:13) @lasted(4h43m45s)
                    â˜ Don't actually starting watching for results until `!obr startgame` is used, unless the lobby was added to an already-started game @created(19-09-02 13:57)
                    â˜ We should be able to add a lobby to an already-started game and just have the score calculator calculate scores for registered players in the new lobby during the score-calculation at the end of each match @created(19-09-02 13:58)
                âœ” `!obr removelobby <banchoMpId>` @created(19-09-01 23:05) @done(19-09-01 23:05)
                    âœ” Add a manual remove-lobby command. Include description like "this will not close the actual lobby; it will only tell the bot to stop scanning the lobby for future results." @started(19-08-19 00:30) @done(19-08-19 05:13) @lasted(4h43m45s)
            User Roles:
                â˜ `!obr addref @<discordUser>, @<discordUser>, ...` @created(19-08-31 23:41)
                â˜ `!obr removeref @<discordUser>, @<discordUser>, ...` @created(19-08-31 23:41)
                â˜ `!obr listrefs` @created(19-08-31 23:41)
            Teams:
                âœ” `!obr addteam <ouid1> <ouid2> ...` @created(19-08-31 23:41) @started(19-09-07 16:48) @done(19-09-22 13:37) @lasted(2w20h49m1s)
                    Adds a team of osu users. See targetgame command.
                    âœ” Allow multiline like `!obr addteams\n<ouid1> <ouid2>\n<ouid3> <ouid4>\n...` @created(19-08-31 14:04) @done(19-09-20 13:42)
                    â˜ If match results are processed before any teams are added @created(19-09-07 16:51)
                        âœ˜ osu users from the results are created and added to a new team of 1 @cancelled(19-09-20 13:43)
                        âœ˜ But then if a team is created with 2+ osu users, and one of those osu users is in the team of 1, delete the team of 1 and create a new team with the 2+ osu users @cancelled(19-09-20 13:43)
                        â˜ Do not create any teams. Create the osu users only. @created(19-09-20 13:43)
                    â˜ How do we handle database integrity if we delete a team? @created(19-09-19 00:34)
                    âœ” In TeamResponseFactory - Make subject GameTeam instead of Team @created(19-09-19 00:34) @done(19-09-19 00:35)
                    âœ” In AddTeamDiscordMessageBuilder - Replace "Team ID x"  with "Team Number y (color)" @created(19-09-19 00:34) @done(19-09-19 00:35)
                    âœ” In AddTeamDiscordMessageBuilder - Replace command example with -- remove team using !obr removeteam <teamNumber> (instead of <teamId>) @created(19-09-19 00:34) @done(19-09-19 00:35)
                â˜ `!obr removeteam <ouid1> <ouid2> ...` @created(19-08-31 23:41)
                â˜ `!obr clearteams` DESTRUCTIVE @created(19-08-31 23:41)
            Matches:
                â˜ `!obr undoresult <mapId?/mapName?>` @created(19-09-02 13:40)
                    Undoes the last match result for this game (i.e. when a map should be replayed).
                    Match scores are marked as skipped, and the preceeding lost team life gets restored.
                    If the game ended, it is restored to active.
                    If this command is fired multiple times, it keeps undoing the result preceeding the previous undone one.
                    â˜ mapName @created(19-09-02 13:49)
                        Clever search to target the result of a specific map.
                    â˜ Some minimum distance time @created(19-09-02 13:50)
                        So if a result comes in immediately before they use the command, it doesn't undo that immediate recent result - it should target the result prior to that one instead. 
                â˜ `!obr redoresult <mapId?/mapName?>` @created(19-09-02 13:43)
                    In case they want to undo the undo.
                â˜ `!obr undoabort <matchId>` @created(19-09-22 13:40)
            Leaderboard:
                â˜ `!obr emoji` or `!obr icons` @created(19-09-06 08:19)
                    Lists every "team performance icon" and explains what each one represents (e.g. ğŸ¥„ = Team ended in last place)
            Scores:
                â˜ `!obr addscore <matchId> <osuUserId> <score>` @created(19-09-22 13:40)
                    â˜ Validate: @created(19-09-22 13:43)
                        â˜ user is permitted @created(19-09-22 13:44)
                        â˜ valid match ID @created(19-09-22 13:43)
                        â˜ osu user exists in team in game. @created(19-09-22 13:43)
                        â˜ score gte 0 @created(19-09-22 13:43)
                    â˜ Bot should recalculate entire game results after every addscore command, and output 1 report with the current leaderboard. @created(19-09-22 13:43)
                â˜ `!obr removescore <matchId> <osuUserId>` @created(19-09-22 13:40)
                    â˜ Validate: @created(19-09-22 13:43)
                        â˜ user is permitted @created(19-09-22 13:44)
                        â˜ valid match ID @created(19-09-22 13:43)
                        â˜ osu user exists in team in game. @created(19-09-22 13:43)
                    â˜ Bot should recalculate entire game results after every removescore command, and output 1 report with the current leaderboard. @created(19-09-22 13:43)
                â˜ `!obr listscores <matchId>` @created(19-09-22 13:45)
        Lobby Management: 

        Game Management: 
            â˜ Add command `!obr game <gameId> <prop> <newPropValue>` @created(19-08-31 13:59)
        Server Management:
            âœ˜ Add discord command `!obr set-channels-category "OBR Games"` @cancelled(19-08-22 20:14)
                This should create a new Discord-category (container of text-channels) where all future-created game-channels will be created in for this server.
    Multiplayer Matches:
        â˜  Use lobby.startingMapNumber to skip some map results
            osu-lobby-watcher.ts -> refreshAndEmitMultiplayerResults()
        â˜ Handle match aborts
            I think we can do this by comparing the start time and end time of the match against the beatmap length. If the match started and ended before the map could have possibly completed, assume it was aborted.
            â˜ Send discord message if it looks like the last match was aborted. 
                â˜ Use the OsuLobbyScanner to send an "aborted match" event. A Discord message sender will then observe this event and send a message to the game channel.
                â˜ Use "!obr include <matchId/mapNumber>" to essentially "undo" the abort, and thereby choose to include scores from the aborted match. This is incase the system mistakingly analyzed the match as aborted. @created(19-09-04 15:10)
        â˜ Process match results @created(19-09-03 11:19) @started(19-09-03 11:19)
            â˜ Add OsuUser entity @created(19-09-03 19:37)
            â˜ Add TeamScore entity @created(19-09-03 19:37)
            â˜ Add MultiplayerMatch entity @created(19-09-03 19:38)
        â˜ A team can continue submitting scores after eliminated, but they won't be counted for anything important - only included with the report to be displayed in the match results message. @created(19-09-04 11:03)
        â˜ Team rank/leaderboard @created(19-09-04 10:08)
            Rank 1...n listed from top to bottom in order of
                -- time when eliminated (team listed further towards the top if their time eliminated is more recent)
                -- current lives remaining (higher lives => higher rank)
                -- cumulative number of positions achieved (e.g. Team A has positioned higher than Team B on average during this game => list Team A above Team B)
                -- total of all team scores achieved during this game
                ^ (algorithm: proceed to continue checking the next condition only if the current condition is equal)
        â˜ How should we handle a match consisting of only 1 player? @created(19-09-19 17:45)
            -- Solution 1: Calculate match results like normal, but no lives are lost. i.e. the game continues forever until another player joins.
            
    Tournament Client Notes:
        -- 
    App Design:
        Displaying info about the game state in OBS:
            Links:
                -- BR Clip: https://clips.twitch.tv/BoringSingleTildeTriHard
                -- Number of scenes needed in OBS: https://docs.google.com/spreadsheets/d/1rPxYmPPBAcL4kxhcIbevoca_3wkXkN-4CEdIrAR4TWE/edit#gid=0
                -- obs-websockets - https://theomynomy.s-ul.eu/aBlcIPhu
                -- IPC
                    -- https://github.com/ppy/osu/blob/master/osu.Game.Tournament/IPC/FileBasedIPC.cs
                    -- https://github.com/NotAdam/osu-ipc/blob/master/osu!meme/osu/Interprocess.cs
                -- tourney client setup: https://osu.ppy.sh/help/wiki/osu!tourney/Setup/
            â˜ MVP Requirements @created(19-09-10 19:31)
                â˜ Show lives remaining per team
                â˜ Show leadboard position per team
                â˜ Show team scores
                    TO do this, we need to memory scan the tournament client osu! instances
                    â˜ We need scores from each of the tournament client windows 
                    â˜ Need to output these to a text file, or transmit over TCP, or IPC, or websockets 
                    â˜ The local bot generates team-scores from memory scanning:
                        9:38 TheOmyNomy: I just output files based on team size.
                        9:38 TheOmyNomy: If it's a team size of 3, there will be a file for slots-1-2-3.txt and slots-4-5-6.txt.
                        â˜ Needs to know the team size - this can just be entered manually by the streamer for now.
            â˜ Ideally, OBS should auto-change scenes based on the number of teams remaining. If a team gets eliminated, they are also eliminated from the overlay. See https://github.com/Palakis/obs-websocket
            â˜ The BR bot should move players around in slots in the lobby, so the team with the most lives remaining is always in the top slots.
            â˜ The BR bot should be transmitting lives-remaining and leaderboard positions, and team-player compositions, and slot positions to an OBS browser source, and to a local bot listening for those events.
                Are we sure we can transmit slot positions for each player, and can we do this in realmtime to keep it as in-sync as possible?
            â˜ The local bot can also listen for the BR-bot websocket events, 
                â˜ and have a real-time record of which osu players are in which slots, @created(19-09-10 21:41)
                âœ˜ which players are in which teams, @created(19-09-10 21:41) @cancelled(19-09-10 21:42)
                â˜ and then reads the osu-clients to get player scores, @created(19-09-10 21:41)
                âœ˜ and then use that to generate team-score txt files for each team. @created(19-09-10 21:41) @cancelled(19-09-10 21:42)
                    â˜ for each group of slots, not for each team @created(19-09-10 21:42)
            â˜ The local bot has: team scores, and which client the scores were calculated from, 
            â˜ The BR bot has team lives remaining, and which players are in which lobby slots.
            â˜ The stream would need to have a new scene for each combination of team-size and teams-remaining situation
                (assumption is that teams are always of equal sizes, e.g. not 1v2v3 or 1v15)
            â˜ If players ina team swap slots with players in another team, the team-score and lives-remaining should also "swap" those positions, but this is depoendent on the local memory reading bot being able to correlate the osu-client position with the player username (i.e. we need to read the player's name from the tournament client memory).
            â˜ To show the lives remaining in each OBS scene in the correct position for the team corresponding to the client-slots, the BR bot will generate a unique URL 
            â˜ Restrictions for players to abide by: 
                â˜ Players in teams always need to be in slots next to each other 
                â˜ As teams are elminated, any teams in slots below the eliminated team should move up, so there should be no gaps in slots between players, and only the bottom slots should be empty 
            â˜ Showing team lives in OBS scenes: @created(19-09-10 22:03)
                https://waffle.bot/game/1/lobby/1/team-lives/slots/1/2
                -- gets the number of lives remaining for the team positioned in slots 1 and 2 in lobby 1 of game 1
                -- browser source can then be added in a static-position in a scene in OBS, and the number of lives will stay in-sync with whatever team is in slots 1 and 2.
                -- websockets client running on this URL
                -- e.g. when a player moves from slot 3 to slot 1, an in-memory DB (e.g. redis) records the new lives of the team of that player in that slot, and the app sends a websockets message to the client which updates the number of lives displayed for that slot-group.
        Match Result Reports:
            Processing Match Results:
                â˜ Entity changes @created(19-09-07 10:20)
                    State changes over time: https://drive.google.com/file/d/1MXJR-XSlzcyyxUxMVRZd83pwLTxoGAvP/view?usp=sharing
                    DB Diagram: https://dbdiagram.io/d/5d1657f5ced98361d6dc2742
                    âœ” Remove TeamScore @done(19-09-07 15:03)
                        Calculate team scores from player scores instead
                    âœ” Remove GameTeamScore @done(19-09-07 15:05)
                    âœ” Add TeamOsuUser (with addedBy) @done(19-09-07 15:21)
                        So we can know who added the user to the team
                    âœ” Add Realm (with realmType string as union of "discord_realm" | "web_realm") @done(19-09-07 16:10)
                        -- This is to avoid privacy issues, by making it possible to filter results in reports like "show all team scores", where if the same team was also created in another realm, we only include team scores belonging to games created in the realm where the command was sent from.
                        -- See CommunicationClientType, but avoid copying these strings to the db in case we rename the types in the codebase later. 
                            â˜ Use an _exhaustiveCheck to map the types to a specific entity (e.g. GameStatus) and retrieve them from a function like "getDatabaseRealmType(from: CommunicationClientType): Entity" @created(19-09-07 10:58) @created(19-09-07 10:58)
                                â˜ This should also be done for any "status" types. @created(19-09-07 10:58)
                                â˜ Maybe create a TypeToDatabaseEntityMapper class. @created(19-09-07 10:57)
                                    â˜ Load those database type-entities from the database during app initialization (populate TypeToDatabaseValueMapper static properties with references to the loaded type-entities) @created(19-09-07 10:59)
                                        This way, we only query the database once at the start of the app. 
                                    â˜ And then update all entity relationships to reference the SpecificTypeEntity. @created(19-09-07 10:57)
                    âœ˜ Consider adding a TeamUserGameTeam entity @cancelled(19-09-07 10:43)
                        -- To accomodate the scenario where we want the user to be able to apply an optional adjustment to any scores set by a user for a specific team in a specific game (e.g. hadicap score by reducing it by 50%).
                        -- I think we could just add this later without needing to change any code? We could add in some procedure during the score-calculation/report-creation process to query this table for any adjustments to be made, before reporting the score.
                â˜ Testing osu multiplayer match results API object transformed into a report object @created(19-09-05 08:25)
                    â˜ arrange: ApiMultiplayer object 
                    â˜ act: do the transforming 
                    â˜ assert: MatchResultsReport object 
                â˜ Input to output steps (API to Report)  @started(19-09-05 11:38)
                    âœ” input: ApiMultiplayer @done(19-09-12 20:08)
                    âœ” find Game using ApiMultiplayer.multiplayerId @done(19-09-12 20:08)
                    âœ” find/create OsuUser[] using ApiMultiplayer.ApiMatch.ApiPlayerScore.osuUserId @done(19-09-12 20:08)
                        
                    â˜ find Team using OsuUser[] and Game
                        TeamRepository.findTeamOfOsuUserInGame(osuUser, game)
                    â˜ create PlayerScore[] from ApiMultiplayer.ApiMatch.ApiPlayerScore
                    â˜ create TeamScore[] from PlayerScore[] and Game (game rules) and ApiMultiplayer.ApiMatch (e.g. match aborted)
                        â˜ Determine events based on the state of the entities
                            entity state -> action -- e.g. lowest TeamScore.score -> Team loses a life
                        â˜ Do actions based on events (e.g. event game winner -> GameService.endGame())
                    â˜ build the leaderboard from entities and events
                    â˜ output: MatchResultsReport
                    â˜ ...use some kind of templating engine to generate the discord message 
                â˜ General idea @created(19-09-06 11:02)
                    â˜ Takes API Multiplayer object
                    â˜ -> UserService
                        âœ” create/find/update User entities @done(19-09-12 20:08)
                        â˜ Update osu username if changed @created(19-09-12 20:08)
                    â˜ -> TeamService
                        â˜ create/find Team entities from users + MP Object
                    â˜ -> ScoringService -> TeamScoreCalculator
                        â˜ calculate team scores
                        â˜ create TeamScore entities from Teams + calulcated scores + MP Object
                    â˜ -> (this)
                        â˜ save the created/updated entities
                    â˜ -> GameEventsBuilder to build GameEvent objects *from stored entities*
                        e.g. like "â­ Team X won the match!" and "ğŸ›‘ Match aborted! No lives were lost."
                        "from entities" is important - so we can recreate them from the database store in future if needed
                    â˜ -> GameLeaderboardBuilder to build GameTeamLine objects
                        -- Should NOT include any formatting/design/emoji - only Types and data
                        -- Independent (I) vs Dependent (D) on other line
                            (I) leaderboard position lost/gained/same
                            (I) team number / team name
                            (I) team performance type (determined from GameEvents)
                            (I) lives remaining
                            (I) lives max
                            (I) team score
                            (I) players scores
                            (I) players map rank achieved
                    â˜ -> GameReportBuilder to build GameReport objects from all the entities/objects
            Reporting Leaderboards on Multiple-Lobby Games:
                âœ˜ Solution 1: @created(19-09-22 13:33) @cancelled(19-09-22 13:33)
                    Don't allow multiple-lobby games, and just deliver a report whenever a lobby map finishes.
                âœ˜ Solution 2: @created(19-09-22 13:33) @cancelled(19-09-22 13:33)
                    Assume the same maps are being played in the same order in all lobbies, and deliver a report whenever the last lobby finishes the map. 
                    (This will be enforcable when the bot can create and manage lobbies [i.e. not in v1 when one of the users creates the lobbies and we just "observe" the lobbies])
                â˜ Solution 3: @created(19-09-22 13:33)
                    - Wait until all lobbies finish a map, then deliver a results-report for that map.
                    - e.g. 
                        - lobby L1 finishes map A at time T, 
                        - lobby L2 finishes map B at time T+1
                        - (bot does not deliver a report) 
                        - bot sends a status message saying "Lobby L1 finished map A. Waiting on results from lobbies B,..."
                        - lobby L2 finishes map A at time T+2
                        - map A has now been completed by all lobbies --> bot delivers report on results for map A
                        - lobby L1 finishes map B at time T+3 
                        - map B has now been completed by all lobbies--> bot delivers report on results for map B
                    - If the same map is played two times in the same lobby, wait to report results for that map until all other lobbies finish the map a second time.
        Discord Message Design:
            Test message design with: https://cog-creators.github.io/discord-embed-sandbox/
            â˜ Example 1 @created(19-09-04 10:55)
                Can each player get their own colour? This would help players locate themselves as the leaderboard shifts around.
                e.g. https://i.imgur.com/9Fhz8yJ.png
                e.g. 
                    Alive (4 maps remain)
                    â¬† 01. Team 1 |ğŸŒŸ| ğŸ¤ğŸ¤ğŸ¤ | Score: 123,456 | player1 [SS], player2 [S]
                    â¬‡ 02. Team 3 |â¬›| ğŸ¤ğŸ¤ğŸ¤ | Score: 111,111ğŸ‘” | p5 [S], player6 [A]
                      03. Team 2 |â¬›| ğŸ¤ğŸ¤ğŸ¤ | Score: 111,111ğŸ‘” | player7 [B], playerlongername8 [C]
                    Eliminated
                    â¬‡ 04. Team 4 |ğŸ’€| ğŸ¤ğŸ¤ğŸ¤ | Score: 100,000 | player3 [D], player4 [B]
                      05. Team 5 |â¬›| ğŸ¤ğŸ¤ğŸ¤ | Score: 0 | player9 [ğŸš«], player10 [F]
            â˜ Emoji indicators @created(19-09-04 09:44)
                â˜ Match 
                    â˜ 5â­ in map title line (5 star map)
                    â˜ Match Summary (may include more than one, listed in order of which is to be written first)
                        â˜ â­ Team X won the match! 
                        â˜ ğŸŒŸ Team X is on a winning streak of N! 
                        â˜ ğŸ’¥ Team X lost a life!
                        â˜ ğŸ’€ Team X was eliminated!
                        â˜ ğŸ›‘ Match aborted! No lives were lost. (Undo with !undoabort <matchId>)
                        â˜ ğŸ‘” Bottom tied! Teams X,Y(,..N-1) tied! No lives were lost.
                            If bottom teams tied (i.e. no loser can be determined)
                        â˜ ğŸ† Game over! The winner is Team X!
                        â˜     Team X now in leaderboard position N (do not output)
                        â˜     Team X gained/lost N leaderboard positions (do not output)
                        â˜     Team X scored N (do not output)
                        â˜     Player P scored N (do not output)
                        â˜     Player P achieved rank SS/S/A... (do not output)
                        â˜     Player P quit (do not output)
                        These events will be processed to determine the leaderboard output
                â˜ Team Line
                    â˜ Team Performance Icon (in order of priority)
                        âœ˜ ğŸ† Tournament winner @cancelled(19-09-15 13:21)
                        â˜ ğŸ¥‡ 1st place (game over) 
                        â˜ ğŸ¥ˆ 2nd place (game over) 
                        â˜ ğŸ¥‰ 3rd place (game over)
                        âœ˜ ğŸ… 4th place (game over) @cancelled(19-09-19 19:14)
                        â˜ ğŸ’€ Skull if team was eliminated this match
                        â˜ ğŸ’¥ Collision if team lost a life
                        âœ˜ ğŸ¤© Perfect Score (all team members SS) @cancelled(19-09-04 15:36)
                        â˜ ğŸŒŸ Team is on a 1st-place winning streak (won gte 2 times in a row)
                        â˜ â­ Team won the match!
                        âœ˜ ğŸŒœ Team had their 1st-place streak ended by another team @cancelled(19-09-04 15:37)
                            ^ Probably best to leave this one out to avoid confusion
                        âœ˜ ğŸ˜­ Team score was exactly 0 @cancelled(19-09-09 08:33)
                        âœ˜ ğŸ˜… Team scored 2nd-last and the score was only 1% more than the last team's score @cancelled(19-09-04 15:36)
                        âœ˜ â™¿ Team score was less than 5% of the highest team score @cancelled(19-09-04 15:36)
                        â˜     Default empty space
                    â˜ Lives 
                        â˜ ğŸ¤ One full-heart for each life remaining
                            -- If maxLives > 5, show "x lives" text instead of hearts.
                        â˜ ğŸ¤ One empty-heart for each life lost 
                    â˜ Leaderboard position
                        â˜ â¬†ğŸ“ˆâ˜ğŸ»  - Gained position
                        â˜ â¬‡ğŸ“‰ğŸ‘‡ğŸ¿ - Lost position  
                        â˜ â¹â†•ï¸â¬œâœ‹ğŸ½ - Same position
                            Or just display an empty space for same position
                    â˜ Player
                        â˜ [S][A][B][C][D][âŒ] Player map rank achieved (listed next to player name)
                            â˜ [âŒ] Listed next to player if they failed the map (regardless of whether or not the game is counting failed scores)
                        â˜ ğŸš« Player left lobby / did not submit map result
                    â˜ Score
                        â˜ ğŸ‘” Tied with at least one other team
            Footer Text Memes:
                â˜ Azer @created(19-09-04 11:55)
                    <WinningTeam> isn't so great? Are you kidding me? When was the last time you saw a player with such aim ability and movement with a tablet? Alex puts the game on another level, and we will be blessed if we ever see a player with his skill and passion for the game again. Cookiezi breaks records. Rafis breaks records. <WinningTeam> breaks the rules. You can keep your statistics. I prefer the magic.
Archive:
